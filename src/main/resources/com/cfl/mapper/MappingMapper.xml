<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
        namespace="com.cfl.mapper.MappingMapper">

    <resultMap id="Authority" type="Authority">
        <id property="authoritySequence" column="auth_seq" />
        <result property="authorityId" column="auth_id"/>
        <result property="authorityName" column="auth_nm"/>
        <result property="authorityType" column="auth_type"/>
        <result property="tenantId" column="tnnt_id"/>
        <result property="serviceName" column="svc_nm"/>
    </resultMap>

    <resultMap id="User" type="User">
        <id property="userSequence" column="user_seq" />
        <result property="userId" column="user_id"/>
        <result property="userType" column="user_type"/>
        <result property="tenantId" column="tnnt_id"/>
        <result property="serviceName" column="svc_nm"/>
    </resultMap>

    <insert id="insertUserAuthority">
        INSERT INTO
            cfl_authority_user_mapping
        VALUES(
            (SELECT
                auth_seq
            FROM
                cfl_authority
            WHERE
                svc_nm = #{user.serviceName}
                AND tnnt_id = #{user.tenantId}
                AND auth_id = #{authorityId})
            ,
            (SELECT
                user_seq
            FROM
                cfl_user
            WHERE
                svc_nm = #{user.serviceName}
                AND tnnt_id = #{user.tenantId}
                AND user_id =#{user.userId})
            )
    </insert>

    <delete id="deleteUserAuthority">
        DELETE FROM
            cfl_authority_user_mapping
        WHERE
            (SELECT
                auth_seq
            FROM
                cfl_authority
            WHERE
                svc_nm = #{user.serviceName}
                AND tnnt_id = #{user.tenantId}
                AND auth_id = #{authorityId})
            AND
            (SELECT
                user_seq
            FROM
                cfl_user
            WHERE
                svc_nm = #{user.serviceName}
                AND tnnt_id = #{user.tenantId}
                AND user_id =#{user.userId})
    </delete>

    <insert id="insertObjectAuthority">
        INSERT INTO
            cfl_object_authority_mapping (auth_seq, objt_seq)
        VALUE
            (#{authority.authoritySequence}
            , #{object.objectSequence})
    </insert>

    <delete id="deleteObjectAuthority">
        DELETE FROM
            cfl_object_authority_mapping
        WHERE
            auth_seq = #{authority.authoritySequence}
            AND objt_seq = #{object.objectSequence}
    </delete>

    <select id="selectObjectIdSubObjectIdListMap" resultType="Map">
        SELECT
	        ob.objt_id
	        ,sob.objt_id AS sub_objt_id
        FROM
            cfl_object ob
            INNER JOIN
                cfl_object_subobject_mapping sobm
            ON
                ob.objt_seq = sobm.objt_seq
            INNER JOIN
                cfl_object sob
            ON
                sobm.sub_objt_seq = sob.objt_seq
        WHERE
            ob.svc_nm = #{serviceName}
	        AND ob.tnnt_id = #{tenantId}
    </select>

    <select id="selectObjectAuthorityIds">
        SELECT
	        auth.auth_id
        FROM
            cfl_object ob
            INNER JOIN
                cfl_object_authority_mapping authm
            ON
                ob.objt_seq = authm.objt_seq
            INNER JOIN
                cfl_authority auth
            ON
                authm.auth_seq = auth.auth_seq
        WHERE
            ob.svc_nm = #{serviceName}
	        AND ob.tnnt_id = #{tenantId}
	        AND ob.objt_id = #{objectId}
    </select>

    <select id="selectUserAuthorities" resultType="Authority">
        SELECT
	        auth.*
        FROM
            cfl_user user
            INNER JOIN
                cfl_authority_user_mapping authm
            ON
                user.user_seq = authm.user_seq
            INNER JOIN
                cfl_authority auth
            ON
                authm.auth_seq = auth.auth_seq
        WHERE
            user.svc_nm = #{serviceName}
	        AND user.tnnt_id = #{tenantId}
	        AND user.user_id = #{userId}
    </select>

    <select id="selectAuthorityUsers" resultType="User">
        SELECT
	        user.*
        FROM
            cfl_user user
            INNER JOIN
                cfl_authority_user_mapping authm
            ON
                user.user_seq = authm.user_seq
            INNER JOIN
                cfl_authority auth
            ON
                authm.auth_seq = auth.auth_seq
        WHERE
            auth.svc_nm = #{serviceName}
	        AND auth.tnnt_id = #{tenantId}
	        AND auth.auth_id = #{authorityId}
    </select>

    <select id="selectObjectIdAuthorityIdListMap" resultType="Map">
        SELECT
	        ob.objt_id
	        ,auth.auth_id
        FROM
            cfl_object ob
            INNER JOIN
                cfl_object_authority_mapping authm
            ON
                ob.objt_seq = authm.objt_seq
            INNER JOIN
                cfl_authority auth
            ON
                auth.auth_seq = authm.auth_seq
        WHERE
            ob.svc_nm = #{serviceName}
	        AND ob.tnnt_id = #{tenantId}
    </select>
</mapper>